from typing import Optional
from pydantic import BaseModel, Field
import logging
import config

#from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate

from agents.llm_utils import get_llm

class CheckResult(BaseModel):
    """
    Class containing result ()YES or NO) of a check and a reason whay the result is negative.
    """
    result: str = Field(default=None, description = "YES or NO")
    reason: Optional[str] = Field(default=None, description="In case result is NO, put here short explanation why answer is incorrect. Otherwise leave if empty.")

with open("prompts/check_answer_prompt.txt", encoding="utf-8") as f:
    prompt_txt = f.read()

prompt = PromptTemplate.from_template(prompt_txt)
validation_provider = config.VALIDATION_LLM
llm = get_llm(model="base", provider=validation_provider)
#= ChatOpenAI(model="gpt-5", temperature=0)
check_llm = llm.with_structured_output(CheckResult)
check_chain = prompt | check_llm

def vadildate_AI_answer(question: str, answer: str) -> CheckResult:
    try:
        return check_chain.invoke({"question": question, "answer": answer})
    except Exception as e:
        logging.error("Error occured at vadildate_AI_answer.\nException: {e}")
        raise e


if __name__ == "__main__":
    import os

    os.environ["LANGCHAIN_ENDPOINT"]="https://api.smith.langchain.com"
    os.environ["LANGCHAIN_TRACING_V2"] = "true"

    qas = [
        {
            "question": "–ö–∞–∫ –≤ CRM —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –Ω–∞ –±—ç–∫-—Å–ª—É–∂–±—É?",
            "answer": """
üîß **–†–µ—à–µ–Ω–∏–µ**

üß† **–ü–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã**  
–í—ã —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å, –∫–∞–∫ –≤ CRM —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –Ω–∞ –±—ç–∫-—Å–ª—É–∂–±—É.

üí° **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ**  
–í CRM –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –±—ç–∫-—Å–ª—É–∂–±—É –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –õ–ó –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ (–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∫–∞—Ä—Ç–æ—á–∫–æ–π –û–ë–ü –∏ —Ä–∞–∑–¥–µ–ª–æ–º –ó–∞—è–≤–∫–∏).
- –ò–∑ —Å–ø–∏—Å–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ –∑–∞–¥–∞—á –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–ó–∞–¥–∞—á–∏ –≤ –±—ç–∫-—Å–ª—É–∂–±—É¬ª –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–ª–∏–µ–Ω—Ç–∞ (—Ä–∞–∑–¥–µ–ª –ö–ª–∏–µ–Ω—Ç—ã).

–¢–æ –µ—Å—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ –Ω–∞ –±—ç–∫-—Å–ª—É–∂–±—É –≤ CRM –∑–∞–π–¥–∏—Ç–µ –≤ –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∏–µ–Ω—Ç–∞, –¥–∞–ª–µ–µ –≤ —Ä–∞–∑–¥–µ–ª –∑–∞–¥–∞—á –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∑–∞–¥–∞—á—É, –ø–æ—Å–ª–µ —á–µ–≥–æ –æ–Ω–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –Ω–∞ –±—ç–∫-—Å–ª—É–∂–±—É.

‚ÑπÔ∏è **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**  
‚Ä¢ –ó–∞–¥–∞—á–∏ –≤ –±—ç–∫-—Å–ª—É–∂–±—É —á–∞—Å—Ç–æ —Å–≤—è–∑–∞–Ω—ã —Å –∑–∞–≤–µ–¥–µ–Ω–∏–µ–º –∫–∞—Ä—Ç–æ—á–µ–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤, –∑–∞–ø—É—Å–∫–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ —Ä–∞–º–∫–∞—Ö –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ª–∏–∑–∏–Ω–≥–∞.  
‚Ä¢ –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã —Å –∑–∞–¥–∞—á–∞–º–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã –∑–∞–¥–∞—á.  
‚Ä¢ –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–¥–∞—á–∏ –º–æ–≥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è.

üìö **–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏**  
1. *–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á* ‚Äî –æ —Å–ø–æ—Å–æ–±–∞—Ö —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –≤ CRM –∏ —Ä–∞–±–æ—Ç–µ —Å —à–∞–±–ª–æ–Ω–∞–º–∏ –∑–∞–¥–∞—á –±—ç–∫-—Å–ª—É–∂–±—ã.  
2. *–ö–∞–∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–¥–µ–ª–∫—É –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–æ "–≠–∫—Å–ø—Ä–µ—Å—Å—É"* ‚Äî –ø—Ä–∏–º–µ—Ä—ã –∑–∞–¥–∞—á –≤ –±—ç–∫-—Å–ª—É–∂–±—É –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∑–∞–¥–∞—á.  
3. *–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 20241128* ‚Äî —É–ª—É—á—à–µ–Ω–∏—è –ø–æ –∑–∞–¥–∞—á–∞–º –∏ –±—ç–∫-—Å–ª—É–∂–±–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∑–∞–¥–∞—á –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É.

‚ùì **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã**  
–¢–∞–∫–∂–µ —è –º–æ–≥ –±—ã –ø–æ–º–æ—á—å –í–∞–º –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:  
1. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —à–∞–±–ª–æ–Ω—ã –∑–∞–¥–∞—á –≤ CRM?  
2. –ö–∞–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á –≤ –±—ç–∫-—Å–ª—É–∂–±–µ?  
3. –ö–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –±—ç–∫-—Å–ª—É–∂–±—É —á–µ—Ä–µ–∑ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã?
"""
    },
    {
        "question": "–∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∞–≥–µ–Ω—Ç—Å–∫–∏–π –¥–æ–≥–æ–≤–æ—Ä",
        "answer": """
–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –ø–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –∞–≥–µ–Ω—Ç—Å–∫–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞. –ù–∏–∂–µ –∫—Ä–∞—Ç–∫–æ –æ–± –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–∞—Ö:

–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∞–≥–µ–Ω—Ç—Å–∫–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ –æ–±—ã—á–Ω–æ –Ω—É–∂–Ω–æ:  
- –°—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞ (–ø—Ä–∏–Ω—Ü–∏–ø–∞–ª –∏ –∞–≥–µ–Ω—Ç).  
- –ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ (—á—Ç–æ –∞–≥–µ–Ω—Ç –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å –¥–ª—è –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∞).  
- –ü—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Å—Ç–æ—Ä–æ–Ω.  
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞.  
- –£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã –∞–≥–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è.  
- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç–æ—Ä–æ–Ω –∏ –ø–æ—Ä—è–¥–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–ø–æ—Ä–æ–≤.  

–†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —à–∞–±–ª–æ–Ω–∞–º –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –∫–æ–º–ø–∞–Ω–∏–∏ "–ò–Ω—Ç–µ—Ä–ª–∏–∑–∏–Ω–≥" –∏–ª–∏ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –æ—Ç–¥–µ–ª–æ–º –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è.

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –º–æ–≥—É –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∏—Å–∫ –∏–ª–∏ –ø–æ–º–æ—á—å —Å –¥—Ä—É–≥–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏."""}
    ]

    for qa in qas:
        result = vadildate_AI_answer(question=qa["question"], answer=qa["answer"])
        print(result)
